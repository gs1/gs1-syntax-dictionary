---
name: GS1 Syntax Dictionary CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:

  #
  #  CI jobs
  #

  ci-clang:

    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: clang CI
        run: |

          # For llvm-symbolizer
          sudo apt-get -y --no-install-recommends install llvm

          make -C src -j "$(nproc)" test \
            CC=clang SANITIZE=yes SLOW_TESTS=yes
          make -C src -j "$(nproc)" lib \
            CC=clang SANITIZE=yes

  ci-gcc:

    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: gcc CI
        run: |
          make -C src -j "$(nproc)" test \
            CC=gcc ANALYZER=yes SLOW_TESTS=yes
          make -C src -j "$(nproc)" lib CC=gcc ANALYZER=yes

  ci-valgrind:

    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Valgrind memcheck CI
        run: |
          sudo apt-get update
          sudo apt-get -y --no-install-recommends install valgrind
          make -C src -j "$(nproc)" test \
            CC=gcc SLOW_TESTS=yes
          valgrind --tool=memcheck \
            --leak-check=full \
            --show-leak-kinds=all \
            --errors-for-leak-kinds=all \
            --error-exitcode=1 \
            --track-origins=yes \
            -s src/build-test/gs1syntaxdictionary-test

  ci-msvc:

    runs-on: windows-latest

    steps:

      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: MSVC CI
        working-directory: src
        run: |
          msbuild /t:Restore,Build `
            /p:Configuration=release `
            /p:Platform="x86" `
            /warnaserror gs1syntaxdictionary.sln
          build\test\Win32\Release\gs1syntaxdictionary-test.exe

  ci-macos:

    runs-on: macos-latest

    steps:

      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: clang CI
        run: |
          make -C src -j "$(sysctl -n hw.logicalcpu)" \
            test SANITIZE=noleak SLOW_TESTS=yes
          make -C src -j "$(sysctl -n hw.logicalcpu)" \
            lib SANITIZE=noleak

  ci-scan-build:

    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: clang static analyser CI
        run: |
          sudo apt-get update
          sudo apt-get -y --no-install-recommends \
            install clang-tools
          scan-build -o plist \
            make -C src -j "$(nproc)" test \
            CC=clang SLOW_TESTS=yes
          scan-build -o plist \
            make -C src -j "$(nproc)" lib CC=clang
          [ "$(find plist/ -name '*.html')" = '' ];

      - name: "clang static analyzer: Store assets on failure"
        uses: actions/upload-artifact@v4
        with:
          name: clang-scan.tgz
          path: plist/**/*.html
          retention-days: 30
        if: ${{ failure() }}

      - name: check includes for the linters with IWYU
        working-directory: src
        run: |
          sudo apt-get -y --no-install-recommends \
            install iwyu
          find . -name 'lint_*.c' \
            -exec bash -c \
            'iwyu -Xiwyu --error \
            -DUNIT_TESTS -DGS1_LINTER_ERR_STR_EN "$1";
            [[ $? = 0 ]] || false' _ {} \;

      - name: cppcheck
        working-directory: src
        run: |
          sudo apt-get -y --no-install-recommends \
            install cppcheck
          cppcheck --enable=all --force \
            --error-exitcode=1 \
            --check-level=exhaustive \
            --suppress='*:acutest.h' \
            -U GS1_LINTER_CUSTOM_GCP_LOOKUP \
            -U GS1_LINTER_CUSTOM_GCP_LOOKUP_H \
            -U GS1_LINTER_CUSTOM_ISO4217_LOOKUP \
            -U GS1_LINTER_CUSTOM_ISO4217_LOOKUP_H \
            -U GS1_LINTER_CUSTOM_ISO3166ALPHA2_LOOKUP \
            -U GS1_LINTER_CUSTOM_ISO3166ALPHA2_LOOKUP_H \
            -U GS1_LINTER_CUSTOM_ISO3166_LOOKUP \
            -U GS1_LINTER_CUSTOM_ISO3166_LOOKUP_H \
            -U GS1_LINTER_CUSTOM_MEDIA_TYPE_LOOKUP \
            -U GS1_LINTER_CUSTOM_MEDIA_TYPE_LOOKUP_H \
            -U GS1_LINTER_CUSTOM_PACKAGE_TYPE_LOOKUP \
            -U GS1_LINTER_CUSTOM_PACKAGE_TYPE_LOOKUP_H \
            -U CLOCK_MONOTONIC \
            -U RUNNING_ON_VALGRIND \
            -U TEST_FINI -U TEST_INIT \
            -D'DIAG_PUSH=' \
            -D'DIAG_POP=' \
            -D'DIAG_DISABLE_DEPRECATED_DECLARATIONS=' \
            --suppress=missingIncludeSystem \
            -i gs1syntaxdictionary-fuzzer-linters.c .


  #
  #  Create a release for each tagged commit
  #
  create-release:

    if: startsWith(github.ref, 'refs/tags/')

    needs:
      - ci-clang
      - ci-gcc
      - ci-valgrind
      - ci-msvc
      - ci-macos
      - ci-scan-build

    runs-on: ubuntu-latest

    steps:

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          draft: true
          prerelease: false
